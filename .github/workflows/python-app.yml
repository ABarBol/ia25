# GitHub Actions workflow: Automatic repository translation using LibreTranslate
# Trigger: push and pull_request events on the 'develop' branch

name: Translate Repository

on:
  push:
    branches: ["develop"]
  pull_request:
    branches: ["develop"]

permissions:
  contents: write

jobs:
  translate:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker build cache
        uses: actions/cache@v4
        with:
          path: /tmp/.docker-cache
          key: ${{ runner.os }}-docker-cache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-docker-cache-

      - name: Install curl
        run: sudo apt-get update && sudo apt-get install -y curl

      - name: Pull LibreTranslate image (cached)
        run: |
          mkdir -p /tmp/.docker-cache
          docker pull libretranslate/libretranslate:latest || true

      - name: Start LibreTranslate container
        id: libre
        run: |
          echo "Starting LibreTranslate container..."
          docker run -d --name libretranslate \
            -p 5000:5000 \
            -e LT_LOAD_ONLY="en,es,gl" \
            -e LT_DISABLE_WEB_UI=true \
            -e LT_DISABLE_FILES=1 \
            -e LT_NO_CACHE=1 \
            libretranslate/libretranslate:latest

          echo "Waiting for LibreTranslate to become healthy (up to 4 minutes)..."
          for i in {1..24}; do
            if curl -fs http://localhost:5000/health | grep -q '"status":"ok"'; then
              echo "LibreTranslate is ready."
              break
            fi
            echo "Waiting for health check ($i/24)..."
            sleep 10
          done

          # If still not responding, attempt a single restart
          if ! curl -fs http://localhost:5000/health | grep -q '"status":"ok"'; then
            echo "Health check failed; restarting LibreTranslate container."
            docker rm -f libretranslate || true
            docker run -d --name libretranslate \
              -p 5000:5000 \
              -e LT_LOAD_ONLY="en,es,gl" \
              -e LT_DISABLE_WEB_UI=true \
              -e LT_DISABLE_FILES=1 \
              -e LT_NO_CACHE=1 \
              libretranslate/libretranslate:latest
            sleep 120
          fi

          echo "Showing recent container logs..."
          docker logs libretranslate | tail -n 40

      - name: Test translation (EN → ES)
        run: |
          echo "Testing LibreTranslate API (en → es)..."
          curl -s -X POST http://localhost:5000/translate \
            -H "Content-Type: application/json" \
            -d '{"q":"hello world","source":"en","target":"es"}' || true

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run translation script
        env:
          TARGET_LANG: es
          LOCAL_LIBRE: "1"
        run: |
          echo "Running repository translation script..."
          python translations/translate_repo.py

      - name: Commit and push translated files
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -B auto/translate/es
          git add .
          git commit -m "Auto-translate repository [skip ci]" || echo "No changes to commit"
          git push -f origin auto/translate/es

